<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Riso-Cam 3:4</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');

        body {
            background-color: #111;
            color: #fff;
            font-family: 'Space Mono', monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        /* 相机外壳：极简工业风 */
        .camera-body {
            background: #222;
            width: 90%;
            max-width: 420px;
            /* 适配内容高度 */
            padding: 20px; 
            border-radius: 2px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 3:4 画幅容器 */
        .viewport-container {
            width: 100%;
            /* 宽高比 3:4 = 0.75 */
            aspect-ratio: 3/4;
            background: #000;
            position: relative;
            border: 2px solid #fff;
            margin-bottom: 20px;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            /* 关键：保持像素颗粒清晰 */
            image-rendering: pixelated;
        }

        /* 颗粒噪点叠加层（增强质感） */
        .noise-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScyMDAlJyBoZWlnaHQ9JzIwMCUnPjxmaWx0ZXIgaWQ9J24nPjxmZVR1cmJ1bGVuY2UgdHlwZT0nZnJhY3RhbE5vaXNlJyBiYXNlRnJlcXVlbmN5PScwLjc1JyBzdGl0Y2hUaWxlcz0nc3RpdGNoJy8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9JzEwMCUnIGhlaWdodD0nMTAwJScgZmlsbD0ndHJhbnNwYXJlbnQnLz48cmVjdCB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJyBmaWx0ZXI9J3VybCgjbiknIG9wYWNpdHk9JzAuMTUnLz48L3N2Zz4=');
            opacity: 0.3;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        button {
            background: transparent;
            border: 2px solid #fff;
            color: #fff;
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            padding: 12px 24px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.1s;
        }

        button:active {
            background: #fff;
            color: #000;
        }

        #snapBtn {
            background: #f00; /* 红色快门 */
            border-color: #f00;
            color: #000;
        }
        #snapBtn:active {
            background: #fff;
            border-color: #fff;
        }

        .meta-info {
            font-size: 10px;
            color: #666;
            margin-top: 10px;
            width: 100%;
            display: flex;
            justify-content: space-between;
        }

    </style>
</head>
<body>

    <div class="camera-body">
        <div class="viewport-container">
            <canvas id="displayCanvas"></canvas>
            <div class="noise-overlay"></div>
        </div>

        <div class="controls">
            <button id="switchBtn" style="font-size:12px;">CAM ↻</button>
            <button id="snapBtn">SHOOT</button>
            <button id="saveBtn" style="display:none;">SAVE</button>
        </div>
        
        <div class="meta-info">
            <span>RISO-GRAIN v2.0</span>
            <span>RATIO 3:4</span>
        </div>
    </div>

    <video id="rawVideo" autoplay playsinline style="display:none;"></video>

    <script>
        const video = document.getElementById('rawVideo');
        const canvas = document.getElementById('displayCanvas');
        const ctx = canvas.getContext('2d');
        const snapBtn = document.getElementById('snapBtn');
        const saveBtn = document.getElementById('saveBtn');
        const switchBtn = document.getElementById('switchBtn');

        // --- 设置 ---
        // 宽度设为 160，高度按 3:4 计算即 213 (160 * 1.333)
        // 这个分辨率比 GameBoy 高，能保留更多细节，但又有足够的像素颗粒感
        const renderWidth = 160; 
        const renderHeight = 213; 
        
        let isStreaming = false;
        let animationId;
        let currentFacingMode = "environment"; // 默认后置

        // 拜耳矩阵 (Bayer Matrix) 4x4
        // 用来决定像素是否“点亮”，制造噪点渐变效果
        // 数值范围 0-64
        const bayerMatrix = [
            [ 0, 32,  8, 40],
            [48, 16, 56, 24],
            [12, 44,  4, 36],
            [60, 28, 52, 20]
        ];

        async function startCamera() {
            if (isStreaming) {
                video.pause();
                isStreaming = false;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                video.srcObject = stream;
                video.play();
            } catch (err) {
                console.error("Camera Error:", err);
                alert("无法启动摄像头。请确保使用 HTTPS 访问。");
            }
        }

        video.addEventListener('loadedmetadata', () => {
            canvas.width = renderWidth;
            canvas.height = renderHeight;
            isStreaming = true;
            renderFrame();
        });

        function renderFrame() {
            if (!isStreaming) return;

            // 1. 裁剪绘制：实现 cover 效果 (填满 3:4 比例，不拉伸)
            const vidW = video.videoWidth;
            const vidH = video.videoHeight;
            const targetRatio = renderWidth / renderHeight; // 0.75
            const vidRatio = vidW / vidH;

            let sx, sy, sWidth, sHeight;

            if (vidRatio > targetRatio) {
                // 视频比画布宽，裁剪两边
                sHeight = vidH;
                sWidth = sHeight * targetRatio;
                sy = 0;
                sx = (vidW - sWidth) / 2;
            } else {
                // 视频比画布高，裁剪上下
                sWidth = vidW;
                sHeight = sWidth / targetRatio;
                sx = 0;
                sy = (vidH - sHeight) / 2;
            }

            // 将视频帧绘制到小画布上
            ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, renderWidth, renderHeight);

            // 2. 获取像素数据
            let imageData = ctx.getImageData(0, 0, renderWidth, renderHeight);
            let data = imageData.data;

            // 3. 算法核心：RGB 抖动 (Ordered Dithering)
            for (let y = 0; y < renderHeight; y++) {
                for (let x = 0; x < renderWidth; x++) {
                    const i = (y * renderWidth + x) * 4;

                    // 获取当前像素在拜耳矩阵中的阈值 (0-64)
                    // 乘以 4 将其扩展到 0-256 范围，作为对比基准
                    let mapValue = bayerMatrix[y % 4][x % 4] * 4;

                    // 稍微提高对比度：让亮部更亮，暗部更暗
                    // 也可以调整这里的数值来改变“曝光度”
                    const contrast = 1.2; 
                    
                    let r = data[i];
                    let g = data[i + 1];
                    let b = data[i + 2];

                    // 核心逻辑：
                    // 如果 (当前颜色值 + 矩阵阈值) > 255，则该像素通道设为高亮，否则设为暗。
                    // 这种处理会让中间色调变成“红点”和“黑点”的混合，产生那种复古印刷质感。
                    
                    // 这里我们做 "2-bit" 量化 (每个通道只有几个阶梯)，增加色彩丰富度但保持噪点
                    // 阶梯数：值越小，色块越明显；值越大，越细腻。
                    const steps = 2; // 尝试改为 1 就会变成纯粹的 8 色 (红黄蓝绿青品黑白)
                    const stepSize = 255 / steps; // 127.5

                    data[i]     = Math.floor((r * contrast + mapValue) / stepSize) * stepSize;
                    data[i + 1] = Math.floor((g * contrast + mapValue) / stepSize) * stepSize;
                    data[i + 2] = Math.floor((b * contrast + mapValue) / stepSize) * stepSize;
                    
                    // 简单的噪点增强 (模拟 ISO 颗粒)
                    // data[i] += (Math.random() - 0.5) * 10;
                }
            }

            ctx.putImageData(imageData, 0, 0);
            animationId = requestAnimationFrame(renderFrame);
        }

        // 拍照
        snapBtn.addEventListener('click', () => {
            if (isStreaming) {
                isStreaming = false;
                cancelAnimationFrame(animationId);
                video.pause();
                snapBtn.innerText = "RESET";
                snapBtn.style.background = "#fff";
                saveBtn.style.display = "block";
                switchBtn.style.display = "none";
            } else {
                isStreaming = true;
                video.play();
                renderFrame();
                snapBtn.innerText = "SHOOT";
                snapBtn.style.background = "#f00";
                saveBtn.style.display = "none";
                switchBtn.style.display = "block";
            }
        });

        // 保存
        saveBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'RISO-Photo-' + Date.now() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

        // 切换前后摄
        switchBtn.addEventListener('click', () => {
            currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
            startCamera();
        });

        startCamera();

    </script>
</body>
</html>
